version: '3.3'

networks:
  smithnet: {}

services:
  smith:
    container_name: smith
    image: inzania/smith:latest
    build:
      context: ./smith
    networks:
      smithnet:
        aliases:
          - smith
    environment:
      - MG_ENV=${MG_ENV:-DEV}
      - MG_SHR=${MG_SHR}
      - AWS_KEY_ID=${AWS_KEY_ID}
      - AWS_KEY_SEC=${AWS_KEY_SEC}
      - BUILDKITE_BUILD_NUMBER
      - BUILDKITE_JOB_ID
      - ANDROID_SDK_ROOT=/root/Android
      - "BUILDKITE_AGENT_TAGS=queue=default"
      - WORKDIR=/smith
    working_dir: /smith
    volumes:
      - $HOME/.ssh:/root/ssh
      - /var/run/docker.sock:/var/run/docker.sock
      - ${MG_SHR}/builds:/buildkite/builds
      - ${MG_SHR}/smith:/smith
      - type: bind
        read_only: true
        source: ${MG_SHR}/.ss3/
        target: /ss3/

  agent:
    container_name: agent
    image: inzania/agent:latest
    build:
      context: ./agent
    networks:
      smithnet:
        aliases:
          - agent
    environment:
      - MG_ENV=${MG_ENV:-DEV}
      - MG_SHR=${MG_SHR}
      - BUILDKITE_AGENT_NAME
      - BUILDKITE_BUILD_NUMBER
      - BUILDKITE_JOB_ID
      - BUILDKITE_ARTIFACT_UPLOAD_DESTINATION
      - BUILDKITE_S3_ACL=private
      - BUILDKITE_S3_DEFAULT_REGION
      - BUILDKITE_S3_ACCESS_KEY_ID=${AWS_KEY_ID}
      - BUILDKITE_S3_SECRET_ACCESS_KEY=${AWS_KEY_SEC}
      - AWS_ACCESS_KEY_ID=${AWS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_KEY_SEC}
      - "AWS_DEFAULT_REGION=us-east-1"
      - "BUILDKITE_AGENT_TAGS=queue=default"
    volumes:
      - $HOME/.ssh/docker-credential-ecr-login:/usr/local/bin/docker-credential-ecr-login
      - $HOME/.ssh:/root/ssh
      - ${MG_SHR}/builds:/buildkite/builds
      - ${MG_SHR}/smith:/smith
      - /var/run/docker.sock:/var/run/docker.sock
      - type: bind
        read_only: true
        source: ${MG_SHR}/.ss3/
        target: /ss3/
