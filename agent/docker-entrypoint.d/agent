#!/bin/bash
echo "Agent."
set -euo

if [[ -z $MG_ENV ]]; then
  echo "ERROR: Need \$MG_ENV configuration."
  exit 1
fi


atf="/ss3/buildkite_agent_token"
if [[ ! -f $atf ]]; then # Not a buildkite agent; just running an op.
  echo "no agent token"
  exit 0
fi

if [[ ! -d /root/.ssh ]]; then mkdir /root/.ssh; fi
if [[ ! -f /root/ssh/id_rsa ]]; then #
  echo "no agent id rsa"
  exit 0
fi
cp /root/ssh/id_rsa /root/.ssh/id_rsa
chmod 400 /root/.ssh/id_rsa

at=$(cat $atf)
echo "Configuring as BuildKite Agent"
# AWS_KEY_ID=${AWS_KEY_ID:-$(cat /ss3/aws_key_id)}
# AWS_KEY_SEC=${AWS_KEY_SEC:-$(cat /ss3/aws_key_sec)}

#if [[ ! -d /etc/buildkite-agent/ ]]; then mkdir /etc/buildkite-agent/; fi
#cat /tmp/buildkite-agent.cfg >> /etc/buildkite-agent/buildkite-agent.cfg
sed -i "s/xxx/$at/g" /etc/buildkite-agent/buildkite-agent.cfg
